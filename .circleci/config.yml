version: 2
jobs:
  build:
    docker:
      - image: circleci/node:10
      - image: mongo

    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: "Install dependencies"
          command: npm install
      - run:
          name: "Install Heroku CLI"
          command: curl https://cli-assets.heroku.com/install.sh | sh
      - run:
          name: "Login to Docker"
          command: docker login --email=$HEROKU_LOGIN --username=$HEROKU_LOGIN --password=$HEROKU_API_KEY registry.heroku.com
      - run:
          name: "Build Docker Image"
          command: docker build build -t registry.heroku.com/minh-social/web .
      - run:
          name: "Push Docker Image To Heroku registry"
          command: docker push registry.heroku.com/minh-social/web:latest
      - run:
          name: "Deploy image to Heroku app"
          command: heroku container:release web --app minh-social
